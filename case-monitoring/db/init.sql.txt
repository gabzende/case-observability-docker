--
-- PostgreSQL database dump
--

\restrict evSn4x8ceGswCAm4GLl4w2pVvdWbGZLyEEu4ouc9OCoAbsW0RWJlLmV1JTxijWr

-- Dumped from database version 18.1
-- Dumped by pg_dump version 18.1

-- Started on 2026-01-12 09:49:44

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET transaction_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

SET default_tablespace = '';

SET default_table_access_method = heap;

--
-- TOC entry 224 (class 1259 OID 16425)
-- Name: alerts; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.alerts (
    id integer NOT NULL,
    ts timestamp with time zone NOT NULL,
    alert_type text NOT NULL,
    severity_score double precision NOT NULL,
    details jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now()
);


ALTER TABLE public.alerts OWNER TO postgres;

--
-- TOC entry 223 (class 1259 OID 16424)
-- Name: alerts_id_seq; Type: SEQUENCE; Schema: public; Owner: postgres
--

CREATE SEQUENCE public.alerts_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


ALTER SEQUENCE public.alerts_id_seq OWNER TO postgres;

--
-- TOC entry 5073 (class 0 OID 0)
-- Dependencies: 223
-- Name: alerts_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: postgres
--

ALTER SEQUENCE public.alerts_id_seq OWNED BY public.alerts.id;


--
-- TOC entry 219 (class 1259 OID 16395)
-- Name: checkout_1; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.checkout_1 (
    "time" text,
    today integer,
    yesterday integer,
    same_day_last_week integer,
    avg_last_week numeric(10,2),
    avg_last_month numeric(10,2)
);


ALTER TABLE public.checkout_1 OWNER TO postgres;

--
-- TOC entry 220 (class 1259 OID 16400)
-- Name: checkout_2; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.checkout_2 (
    "time" text,
    today integer,
    yesterday integer,
    same_day_last_week integer,
    avg_last_week numeric(10,2),
    avg_last_month numeric(10,2)
);


ALTER TABLE public.checkout_2 OWNER TO postgres;

--
-- TOC entry 228 (class 1259 OID 16484)
-- Name: transaction_alerts; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.transaction_alerts (
    id bigint NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    bucket_ts timestamp with time zone NOT NULL,
    state text NOT NULL,
    denied_above_normal boolean DEFAULT false NOT NULL,
    failed_above_normal boolean DEFAULT false NOT NULL,
    reversed_above_normal boolean DEFAULT false NOT NULL,
    reasons text[] DEFAULT '{}'::text[] NOT NULL,
    severity_score double precision DEFAULT 0 NOT NULL,
    total integer DEFAULT 0 NOT NULL,
    approved integer DEFAULT 0 NOT NULL,
    denied integer DEFAULT 0 NOT NULL,
    failed integer DEFAULT 0 NOT NULL,
    reversed integer DEFAULT 0 NOT NULL,
    denied_rate double precision DEFAULT 0 NOT NULL,
    failed_rate double precision DEFAULT 0 NOT NULL,
    reversed_rate double precision DEFAULT 0 NOT NULL,
    denied_mean double precision,
    denied_std double precision,
    failed_mean double precision,
    failed_std double precision,
    reversed_mean double precision,
    reversed_std double precision,
    raw_payload jsonb,
    CONSTRAINT transaction_alerts_state_check CHECK ((state = ANY (ARRAY['firing'::text, 'resolved'::text])))
);


ALTER TABLE public.transaction_alerts OWNER TO postgres;

--
-- TOC entry 227 (class 1259 OID 16483)
-- Name: transaction_alerts_id_seq; Type: SEQUENCE; Schema: public; Owner: postgres
--

CREATE SEQUENCE public.transaction_alerts_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


ALTER SEQUENCE public.transaction_alerts_id_seq OWNER TO postgres;

--
-- TOC entry 5074 (class 0 OID 0)
-- Dependencies: 227
-- Name: transaction_alerts_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: postgres
--

ALTER SEQUENCE public.transaction_alerts_id_seq OWNED BY public.transaction_alerts.id;


--
-- TOC entry 221 (class 1259 OID 16405)
-- Name: transactions; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.transactions (
    ts timestamp with time zone NOT NULL,
    status text NOT NULL,
    count integer NOT NULL
);


ALTER TABLE public.transactions OWNER TO postgres;

--
-- TOC entry 222 (class 1259 OID 16415)
-- Name: transactions_auth_codes; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.transactions_auth_codes (
    ts timestamp with time zone NOT NULL,
    auth_code integer NOT NULL,
    count integer NOT NULL
);


ALTER TABLE public.transactions_auth_codes OWNER TO postgres;

--
-- TOC entry 225 (class 1259 OID 16467)
-- Name: v_tx_minute; Type: VIEW; Schema: public; Owner: postgres
--

CREATE VIEW public.v_tx_minute AS
 SELECT ts,
    sum(count) AS total,
    sum(count) FILTER (WHERE (status = 'approved'::text)) AS approved,
    sum(count) FILTER (WHERE (status = 'denied'::text)) AS denied,
    sum(count) FILTER (WHERE (status = 'failed'::text)) AS failed,
    sum(count) FILTER (WHERE (status = ANY (ARRAY['reversed'::text, 'backend_reversed'::text]))) AS reversed,
    ((sum(count) FILTER (WHERE (status = 'denied'::text)))::double precision / (NULLIF(sum(count), 0))::double precision) AS denied_rate,
    ((sum(count) FILTER (WHERE (status = 'failed'::text)))::double precision / (NULLIF(sum(count), 0))::double precision) AS failed_rate,
    ((sum(count) FILTER (WHERE (status = ANY (ARRAY['reversed'::text, 'backend_reversed'::text]))))::double precision / (NULLIF(sum(count), 0))::double precision) AS reversed_rate
   FROM public.transactions
  GROUP BY ts;


ALTER VIEW public.v_tx_minute OWNER TO postgres;

--
-- TOC entry 226 (class 1259 OID 16472)
-- Name: v_tx_anomaly; Type: VIEW; Schema: public; Owner: postgres
--

CREATE VIEW public.v_tx_anomaly AS
 WITH base AS (
         SELECT v.ts,
            v.total,
            v.approved,
            v.denied,
            v.failed,
            v.reversed,
            v.denied_rate,
            v.failed_rate,
            v.reversed_rate,
            avg(v.denied_rate) OVER w AS denied_mean,
            stddev_samp(v.denied_rate) OVER w AS denied_std,
            avg(v.failed_rate) OVER w AS failed_mean,
            stddev_samp(v.failed_rate) OVER w AS failed_std,
            avg(v.reversed_rate) OVER w AS reversed_mean,
            stddev_samp(v.reversed_rate) OVER w AS reversed_std
           FROM public.v_tx_minute v
          WINDOW w AS (ORDER BY v.ts ROWS BETWEEN 30 PRECEDING AND 1 PRECEDING)
        )
 SELECT ts,
    total,
    approved,
    denied,
    failed,
    reversed,
    denied_rate,
    failed_rate,
    reversed_rate,
    denied_mean,
    denied_std,
    failed_mean,
    failed_std,
    reversed_mean,
    reversed_std,
        CASE
            WHEN ((total >= 30) AND (denied_std IS NOT NULL) AND (denied_rate > (denied_mean + ((3)::double precision * denied_std)))) THEN true
            ELSE false
        END AS denied_above_normal,
        CASE
            WHEN ((total >= 30) AND (failed_std IS NOT NULL) AND (failed_rate > (failed_mean + ((3)::double precision * failed_std)))) THEN true
            ELSE false
        END AS failed_above_normal,
        CASE
            WHEN ((total >= 30) AND (reversed_std IS NOT NULL) AND (reversed_rate > (reversed_mean + ((3)::double precision * reversed_std)))) THEN true
            ELSE false
        END AS reversed_above_normal
   FROM base;


ALTER VIEW public.v_tx_anomaly OWNER TO postgres;

--
-- TOC entry 4885 (class 2604 OID 16428)
-- Name: alerts id; Type: DEFAULT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY public.alerts ALTER COLUMN id SET DEFAULT nextval('public.alerts_id_seq'::regclass);


--
-- TOC entry 4888 (class 2604 OID 16487)
-- Name: transaction_alerts id; Type: DEFAULT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY public.transaction_alerts ALTER COLUMN id SET DEFAULT nextval('public.transaction_alerts_id_seq'::regclass);


--
-- TOC entry 4910 (class 2606 OID 16438)
-- Name: alerts alerts_pkey; Type: CONSTRAINT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY public.alerts
    ADD CONSTRAINT alerts_pkey PRIMARY KEY (id);


--
-- TOC entry 4912 (class 2606 OID 16446)
-- Name: alerts alerts_unique_ts_type; Type: CONSTRAINT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY public.alerts
    ADD CONSTRAINT alerts_unique_ts_type UNIQUE (ts, alert_type);


--
-- TOC entry 4917 (class 2606 OID 16523)
-- Name: transaction_alerts transaction_alerts_pkey; Type: CONSTRAINT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY public.transaction_alerts
    ADD CONSTRAINT transaction_alerts_pkey PRIMARY KEY (id);


--
-- TOC entry 4908 (class 2606 OID 16422)
-- Name: transactions_auth_codes transactions_auth_codes_pkey; Type: CONSTRAINT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY public.transactions_auth_codes
    ADD CONSTRAINT transactions_auth_codes_pkey PRIMARY KEY (ts, auth_code);


--
-- TOC entry 4905 (class 2606 OID 16414)
-- Name: transactions transactions_pkey; Type: CONSTRAINT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY public.transactions
    ADD CONSTRAINT transactions_pkey PRIMARY KEY (ts, status);


--
-- TOC entry 4913 (class 1259 OID 16439)
-- Name: idx_alerts_ts; Type: INDEX; Schema: public; Owner: postgres
--

CREATE INDEX idx_alerts_ts ON public.alerts USING btree (ts DESC);


--
-- TOC entry 4906 (class 1259 OID 16423)
-- Name: idx_transactions_auth_codes_ts; Type: INDEX; Schema: public; Owner: postgres
--

CREATE INDEX idx_transactions_auth_codes_ts ON public.transactions_auth_codes USING btree (ts);


--
-- TOC entry 4914 (class 1259 OID 16526)
-- Name: ix_transaction_alerts_bucket_ts_desc; Type: INDEX; Schema: public; Owner: postgres
--

CREATE INDEX ix_transaction_alerts_bucket_ts_desc ON public.transaction_alerts USING btree (bucket_ts DESC);


--
-- TOC entry 4915 (class 1259 OID 16525)
-- Name: ix_transaction_alerts_created_at_desc; Type: INDEX; Schema: public; Owner: postgres
--

CREATE INDEX ix_transaction_alerts_created_at_desc ON public.transaction_alerts USING btree (created_at DESC);


--
-- TOC entry 4918 (class 1259 OID 16524)
-- Name: ux_transaction_alerts_bucket_state; Type: INDEX; Schema: public; Owner: postgres
--

CREATE UNIQUE INDEX ux_transaction_alerts_bucket_state ON public.transaction_alerts USING btree (bucket_ts, state);


-- Completed on 2026-01-12 09:49:44

--
-- PostgreSQL database dump complete
--

\unrestrict evSn4x8ceGswCAm4GLl4w2pVvdWbGZLyEEu4ouc9OCoAbsW0RWJlLmV1JTxijWr

-- Importar dados iniciais (seed)
\i /docker-entrypoint-initdb.d/data/checkout_1.sql
\i /docker-entrypoint-initdb.d/data/checkout_2.sql
\i /docker-entrypoint-initdb.d/data/transactions.sql
\i /docker-entrypoint-initdb.d/data/transactions_auth_codes.sql
\i /docker-entrypoint-initdb.d/data/transaction_alerts.sql


